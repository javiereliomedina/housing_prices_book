# Housing data {#BBR-data}   

We load all residences for year-round living (*ENH_ANVEND_KODE*) from the Building and Dwelling Register ([BBR](https://teknik.bbr.dk/forside)), we use this table for disaggregating population density from parish level to grid cells of 100m x 100m. 

- 110           = Farmhouse for agricultural property.  
- 120, 121, 122 = Detached single-family house (detached house). 
- 130, 131, 132 = Townhouse, chain, or semi-detached house (vertical separation between the units).
- 140           = Multi-storey residential building (multi-family house, including two-family house (horizontal separation between the units).
- 150           = College.
- 160           = Residential building for residential institution.
- 190           = Second building for year-round living.

```{r load-BBR, cache=TRUE, dependson = "adm-units", cache.extra = file.mtime(Sys.getenv("OneDrive_BBR_path"))}

# Buildings for year round living
  res_codes <- tribble (~ENH_ANVEND_KODE, ~type,
                        110, "Farmhouse",
                        120, "Single-family house",
                        121, "Single-family house",
                        122, "Single-family house",
                        130, "Semi-detached house",
                        131, "Semi-detached house",
                        132, "Semi-detached house",
                        140, "Multi-storey",
                        150, "College", 
                        160, "Residential institution",
                        190, "Second building") %>%
    # Convert type to factor
    mutate(type = factor(type)) %>%
    # Convert to data.table
    as.data.table()

# Function for reading residential units from a BBR files (.csv):
# Get only residential units in the study area
# @param .file Path to OneDrive with the data (.csv format)
# @param .area Area where we would get the data (default = study_area)

f_res_units  <- function(.file, .area = study_area) { 
  # Select only Residential houses - Buildings for year-round living
  dt <- fread(.file)[ENH_ANVEND_KODE %in% res_codes$ENH_ANVEND_KODE]
  # Input empty cells (buildings with only one floor) in Etagebetegn as "st"
  dt[, Etagebetegn := fifelse(Etagebetegn == "", "st", Etagebetegn)]
  # Etagebetegn as ordered factor
  dt[, Etagebetegn := factor(Etagebetegn, c("k2", "kl", "st", seq(1, 36, 1)), ordered = TRUE)]
  # Group floor levels with 5 or more
  dt[, floor_level := fct_other(Etagebetegn,
                                drop = factor(seq(5, 36)),
                                other_level = "5 or more")]
  # Add residential description (type) into the dataset
  dt <- merge(dt, res_codes, by = "ENH_ANVEND_KODE") 
  # Add year of the BBR dataset  
  dt[ , BBR_year := parse_number(stringr::str_extract(.file, "_[0-9]+_"))] 
  # Convert columns with codes (*_KODE) to character
  cols <- grep("_KODE",  names(dt))
  dt[ , (cols) := lapply(.SD, as.character), .SDcols = cols]
  
  # Convert to sf objects and get only points in the study area
  dt <- dt %>%
    st_as_sf(coords = c("etrs89koordinat_ost", "etrs89koordinat_nord"),
             crs = "EPSG:25832") %>% 
    # Points in the study area
    mutate(int = st_intersects(., .area) %>% lengths > 0) %>% 
    filter(int == TRUE) 
}

# Load all csv files (one file for each year) in the same table with a column indicating the year of the dataset: 
# Load residential units 
# NOTE: you may need to change the path to OneDrive - Aalborg Universitet 
# Read all the data together 
  
  csv_files_path <- list.files(path = Sys.getenv("OneDrive_BBR_path"),
                               pattern = "*.csv",
                               full.names = TRUE)
  
  plan(multisession, workers = 7)
  res_units <- future_map_dfr(.x = csv_files_path, .f = f_res_units)
  plan("default")

```

However, for housing prices we focus our analysis to the main building types in the City of Copenhagen (Figure \@ref(fig:fig-sp-res-builds)), which are in this order: i) multi-storey residential buildings (code 140), ii) detached single-family houses (codes 120, 121, 122), iii) colleges (code 150), and iv) semi-detached houses (codes 130, 131, 132).

```{r, fig-sp-res-builds, fig.width = 9, fig.height = 7, cache = TRUE, dependson = "load-BBR", fig.cap = "2D kernel density map"}

# Aux. function for plotting 2D kernel density maps:
  f <- function(.data) {
    .data %>% 
      st_coordinates() %>%
      as_tibble() %>%
      ggplot() +
      geom_sf(data = cph_parish, fill = "grey", color = "grey50", size = 0.05) +
      geom_point(aes(X, Y), size = 0.02, shape = 16) +
      stat_density_2d(aes(X, Y, fill = ..level..),
                      alpha = 0.5,
                      h = 700,
                      geom = "polygon") +
      scale_fill_distiller(palette = "Spectral")  +
      theme_void() + 
      theme(legend.position = "none") +
      labs(title = .data$type,
           x = "",
           y = "") 
  }

# Plots  
  p <- res_units %>% 
    filter(BBR_year == 2019) %>%  
    # Reorder type factors by the frequency they appear 
    mutate(type = fct_infreq(type)) %>% 
    # Split by house type
    group_split(type) %>%
    map( ~ f(.))
  
  wrap_plots(p) +
    annotation_scale(location = "br", text_cex = 1) +
    annotation_north_arrow(location = "br",
                           pad_x = unit(0.70, "cm"),
                           pad_y = unit(0.65, "cm"),
                           which_north = "true",
                           height = unit(0.5, "cm"),
                           width = unit(0.5, "cm"),
                           style = north_arrow_orienteering(text_col = "white",
                                                            text_size = 1)) +
    plot_annotation(title = "Residential units in 2019",
                    theme = theme(plot.title = element_text(size = 14,
                                                            colour = "darkblue",
                                                            face = "bold"),
                                  plot.caption = element_text(size = 9,
                                                              colour = "grey25")
                    )
    ) 
  
```

Then, we selected from the main residential buildings those that are on the ordinary free trade (*OVERDRAGELSES_KODE == 1 - Almindelig frit salg*) or public sales  (*OVERDRAGELSES_KODE == 3 - Auktion*). Finally, we filtered those dwellings that are actually used for residential purpose (i.e. *BOLIGTYPE_KODE $\neq$ E - Andet (bl.a. institutioner og erhverv)* or *BOLIGTYPE_KODE $\neq$ 5 - Sommer-/fritidsbolig*). Dwelling with a size lower that 10 $m^2$ were removed from the analysis. Colleges were also excluded  from the data analysis since they are a special type of buildings dedicated to students residences mainly outside of the free marked.    

```{r runits-clean, cache = TRUE, dependson = "load-BBR"}

  selected_res_units <- c("Multi-storey", "Single-family house", "Semi-detached house")

  res_units_oft <- res_units %>%
    # Convert to tibble
    as_tibble() %>% 
    # Select main residential units in the area
    filter(type %in% selected_res_units) %>% 
    # ordinary free trade or auction
    filter(OVERDRAGELSES_KODE == "1" | OVERDRAGELSES_KODE == "3") %>% 
    # Remove BOLIGTYPE_KODE = E or 5 form the dataset
    filter(BOLIGTYPE_KODE != "E" | BOLIGTYPE_KODE != "5") %>% 
    # Remove tiny dwellings (area < 10 m2)
    filter(BEBO_ARL >= 10) %>%
    # Drop unused factors levels
    droplevels()
    
```

Finally, we adjusted the housing prices to 2019 prices. In this regard, we take into  account the inflation and, therefore, prices from different years can be compared (@Valtersdorf2020). The adjusted price is obtained as follow:

$$ Pice_{2019} = Price_{i} \cdot \frac{Index_{2019}}{Index_{i}}$$

Where, $Price_{2019}$ is the adjusted housing price for 2019, $Price_{i}$ is the price of the respective year $i$, and $Index_{i}$ and $Index_{2019}$ are the price indexes for the origin year ${i}$ and $2019$, respectively. The indexes have been obtained from Statistic Denmark; i.e. table [EJ66: Price index for sales property (2006=100) by region, category of real property and unit](https://www.statistikbanken.dk/statbank5a/SelectVarVal/Define.asp?MainTable=EJ66&PLanguage=1&PXSId=0&wsid=cftree), and targeted for the study area; i.e. *Province Byen København - Copenhagen City* (Table \@ref(tab:price-index)). Inconsistent values have been removed; i.e. 2019 adjusted prices < 10 kDKK (approx. €1300).  

```{r price-index}

# DST table (EJ66: Price index for sales property (2006=100) by region, category of real property and unit)
  id_table <- "EJ66"
  dat_meta <- get_table_metadata(table_id = id_table, variables_only = TRUE)
  
# Values to retrieve
  variables <- list(
    # Province Byen København: region = 01 
    list(code = "OMRÅDE", values = "01"),
    # Category of real property
    list(code = "EJENDOMSKATE", values = c("0111", "2103")),
    # Index
    list(code = "TAL", values = NA),
    # From 2004 to 2019
    list(code = "Tid", values = seq(2004, 2019, 1))
    )

# Get index
  price_index <- get_data("EJ66", variables) %>% 
    # Get index
    filter(TAL == "Index") %>% 
    # Translate into English 
    rename(region = OMRÅDE,
           category = EJENDOMSKATE,
           unit = TAL,
           date = TID, 
           index = INDHOLD) %>% 
    # Convert index tu numeric
    mutate(index = as.numeric(index)) %>% 
    # Remove region and unit columns
    select(-region, -unit) 
    
# Print price index table  
  price_index %>% 
    # Wide format
    pivot_wider(names_from = date, 
                values_from = index) %>% 
    kbl(caption = "Price index for sale properties in Copenhagen City") %>% 
    kable_paper() %>% 
    scroll_box(width = "100%")
  
```

```{r adj-price}

# Adjust housing prices
price_index_2019 <- filter(price_index, date == 2019) %>% rename(index_2019 = index)

res_units_oft <- res_units_oft %>% 
  # Column with price index categories
  mutate(category = case_when(
    type == "Single-family house" ~ "One-family houses",
    TRUE ~ "Owner-occupied flats, total")) %>%
  # Add price index by year and category
  left_join(price_index, by = c("category" = "category",
                                "BBR_year" = "date")) %>% 
  # Add price index in 2019 by category
  left_join(price_index_2019, by = c("category" = "category")) %>% 
  # Calculate prices 2019
  mutate(price2019_kDKK = (KONTANT_KOEBESUM * index_2019 / index) / 1000) %>% 
  # Remove prices < 10 kDKK
  filter(price2019_kDKK >= 10)
  
```

The housing price per square meter ($kDDK/m^2$) is calculated by dividing the 2019 adjusted prices by the dwelling size (*BEBO_ARL*).

```{r price-per-meter}

res_units_oft <- res_units_oft %>% 
  # Price per m2
  mutate(price2019_kDKK_m2 = price2019_kDKK / BEBO_ARL)

```

The total number of residential units used for the analysis is `r nrow(res_units_oft)` (Table \@ref(tab:tbl-runits-clean)).
```{r tbl-runits-clean, cache = TRUE, dependson = "runits-clean"}

# Table with Number of residential units
  res_units_oft %>%
    # Summarize by type or residency and year
    group_by(type, BBR_year) %>% 
    summarise(n = n()) %>% 
    ungroup() %>%
    # Arrange and add row with totals
    arrange(BBR_year, desc(n)) %>%
    # Pivot
    pivot_wider(names_from = BBR_year, values_from = n) %>% 
    adorn_totals("row") %>%
    kbl(caption = "Number of residential dwellings in the free trade by year") %>% 
    kable_paper() %>% 
    row_spec(4, bold = TRUE) %>% 
    scroll_box(width = "100%")

```

The summary descriptive statistics of the housing prices are:
```{r tbl-summary}

# Table theme
theme_gtsummary_compact()

# Create variable labels of the variables to be printed in the table
labelled::var_label(res_units_oft$price2019_kDKK)    <- "Adjusted prices (kDKK)"
labelled::var_label(res_units_oft$BEBO_ARL)          <- "Dwelling size (m2)"
labelled::var_label(res_units_oft$price2019_kDKK_m2) <- "Adjusted prices per square meter (kDKK/m2)"

# Summary table
res_units_oft %>% 
  # Select variables of interest
  select(type, price2019_kDKK,  BEBO_ARL, price2019_kDKK_m2) %>%
  # Summary values
  tbl_summary(by = type,
              type = all_continuous() ~ "continuous2",
              statistic = all_continuous() ~ c("{mean}",
                                               "{median}",
                                               "{p25} - {p75}", 
                                               "{min} - {max}"),
              missing = "no") %>% 
  add_overall() %>% 
  modify_spanning_header(c("stat_1", "stat_2", "stat_3") ~ "**House type**") %>% 
  modify_footnote(update = everything() ~ NA) %>% 
  bold_labels() 

```
