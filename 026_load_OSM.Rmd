# Open Street Map 

We get location information from [Open Street Map](https://wiki.openstreetmap.org/wiki/Map_features). We select services inside a buffer of approx. 2 km around the study area (Figure \@ref(fig:fig-osm-data)), assuming that people may use then (e.g. parks, parking areas) outside Copenhagen City but they are close enough to they houses. 


"A park is an area of open space for recreational use, usually designed and in semi-natural state with grassy areas, trees and bushes - OSM".

## Features

### Areal features

The mass of the service ($M_j$) for the potential model is the area (in $m^2$) of the feature.

Hospital, and Schools (e.g. schools) may create traffic and noise. Therefore, they may have a negative effect on housing prices (@Gultekin2006). 

```{r tbl-osm-data, cache = TRUE}

# List of OSM data
# Available features: https://wiki.openstreetmap.org/wiki/Map_features 

osm_poly_list <- tribble(
  ~feature, ~key, ~value, ~exp_effect,
  # Transportation   
  "Parking", "amenity", "parking", "positive",
  # Green areas
  "Park", "leisure",  c("park", "garden", "playground"), "positive",
  "Forest", "landuse", c("forest", "meadow"), "positive",
  "Forest", "natural", "scrub", "positive",
  "Allotment", "landuse", "allotments", "positive",
  # Education
  "School", "amenity", c("school", "kindergarten"), "negative",
  "University", "amenity", c("university", "college"), "positive", 
  # Healthcare
  "Hospital", "amenity", c("hospital"), "negative"
)

osm_poly_list <- osm_poly_list %>%
  unnest(c(value)) %>% 
  as.data.table() 

osm_poly_list %>% 
  kbl()

```

```{r osm-poly, cache = TRUE, dependson="tbl-osm-data"}

# Bounding of the study area (approx. buffer of 2km)
box <- c(xmin = 714906, xmax = 733618, ymin = 6166579, ymax = 6184092)
bbox <- st_bbox(box)
bbox_sf <- st_as_sfc(bbox) %>%  st_set_crs("EPSG:25832") 

# Get polygons 
osm_poly_dnld <- oe_get(place = "Copenhagen", layer = "multipolygons") %>% 
  # Convert to data.table
  as.data.table() %>% 
  # Long format 
  melt(id.vars = c("osm_id", "osm_way_id", "type", "name", "geometry"),
       variable.name = "key",
       value.name = "value")
 
# Merge and convert to sf
osm_poly <- merge(osm_poly_list, osm_poly_dnld, by = c("key", "value")) %>% 
  # Convert to sf object
  st_sf() %>% 
  # Transform CRS
  st_transform("EPSG:25832") %>% 
  # Remove non-valid polygons (i.e. 2 polygons)
  mutate(valid = st_is_valid(.)) %>% 
  filter(!is.na(valid)) %>% 
  # Calculate the area of the polygons
  mutate(area_m2 = as.numeric(units::set_units(st_area(.), m^2))) %>% 
  # crop to Bounding of the study area %>% 
  st_crop(bbox_sf) %>% 
  # Nest by feature
  group_by(feature) %>% 
  nest() %>% 
  ungroup() %>% 
  rename(data_poly = data) %>% 
  # Get centroids  
  mutate(data_points = map(data_poly, st_centroid))


```


```{r fig-osm-data, cache=TRUE, dependson="osm-poly", fig.cap="OSM data"}

osm_poly %>%
  unnest(cols = c(data_poly)) %>% 
  st_sf() %>% 
  ggplot() +
  geom_sf(data = st_crop(dk_country, bbox_sf), fill = "grey95") +
  geom_sf(data = cph_parish, fill = "grey85", color = "grey50", size = 0.05) +
  geom_sf(fill = "#D55E00", col = NA) +
  labs(caption = "Source: Open Street Map") +
  my_theme_map() +
  facet_wrap(~feature)

```

### Point features

Features: (Figure \@ref(fig:fig-osm-points)) The mass of the service ($M_j$) for the potential model is the same for all the points (i.e. 1).  

- Sustenance: bar, cafe, pubs, etc.
- Shops: supermarket, mall, butcher, etc.

```{r osm-points, cache=TRUE}

# Sustenance (points)

osm_points_list <- tribble(
  ~feature, ~key, ~value, ~exp_effect,
  # Sustenance
  "Sustenance", "amenity", c("bar", "biergarten", "cafe", "fast_food", "food_court",
                             "ice_cream", "pub", "restaurant"), "negative",
  # Shops
  "Shop", "shop", c("supermarket", "mall", "general", "dairy", "department_store",
                    "butcher", "seafood", "bakery", "convenience"), "positive",
  # Entertainment, Arts & Culture....
  "Positive entertainment", "amenity", c("cinema", "social_centre", "theatre",
                                "community_centre", "arts_centre", "public_bookcase"), "positive",
  "Negative entertainment", "amenity", c("brothel", "casino", "gambling", "love_hotel",
                                         "nightclub", "stripclub", "swingerclub"), "negative",
  # Healthcare
  "Social facility", "amenity",  "social_facility", "negative"
  ) %>%
  unnest(cols = c(value)) %>% 
  as.data.table()

osm_points_dnld <- oe_get(place = "Copenhagen",
            layer = "points",
            extra_tags = c("amenity", "shop"),
            provider = "bbbike") %>%  
  # Convert to data.table
  as.data.table() %>% 
  # Long format 
  melt(id.vars = c("osm_id", "name", "address", "geometry"),
       variable.name = "key",
       value.name = "value")

osm_points <-  merge(osm_points_list, osm_points_dnld, by = c("key", "value")) %>% 
  # Convert to sf object
  st_sf() %>% 
  # Transform CRS
  st_transform("EPSG:25832") %>% 
  # crop to Bounding of the study area %>% 
  st_crop(bbox_sf) %>% 
  # Mass of the service
  mutate(area_m2 = 1)  %>% # NOTE: Change Name!!
  # Nest by feature
  group_by(feature) %>% 
  nest() %>% 
  rename(data_points = data)  
  

```

```{r fig-osm-points, cache=TRUE, dependson="osm-points", fig.cap="OSM data points"}

osm_points %>%
  unnest(cols = c(data_points)) %>% 
  st_sf() %>% 
  ggplot() +
  geom_sf(data = st_crop(dk_country, bbox_sf), fill = "grey95") +
  geom_sf(data = cph_parish, fill = "grey85", color = "grey50", size = 0.05) +
  geom_sf(colour = "#D55E00", size = 0.5) +
  labs(caption = "Source: Open Street Map") +
  my_theme_map() +
  facet_wrap(~feature)

```

## Potential model

Spatial interaction function (Figure \@ref(fig:spat-inter)).
```{r spat-inter, fig.width = 12, fig.height = 4, fig.cap="Spatial interaction function"}

par(mfrow=c(1,2))

plot_inter(fun = "e",  span = 300, beta = 2)
plot_inter(fun = "e",  span = 1000, beta = 2)

```

Potential model (Figure \@ref(fig:fig-pot-model))

```{r sif-pot-model, cache=TRUE, dependson="tbl-osm-data"}
# Based on: https://riatelab.github.io/potential/articles/potential.html

# Set Spatial Interaction Function (fun, span, beta)
sif <- tribble(   ~feature, ~fun,  ~span, ~beta,
                 "Parking",  "e",    300,     2,
                    "Park",  "e",    300,     2,
                  "Forest",  "e",   1000,     2,
                  "School",  "e",    300,     2,
              "University",  "e",    300,     2,
                "Hospital",  "e",    300,     2,
               "Allotment",  "e",    300,     2,
  "Positive entertainment",  "e",    300,     2,
              "Sustenance",  "e",    300,     2,
  "Negative entertainment",  "e",    300,     2,
         "Social facility",  "e",    300,     2,
                    "Shop",  "e",    300,     2
  )

# All OMS data
OMS <- osm_poly %>%
  select(feature, data_points) %>% 
  bind_rows(osm_points) %>% 
  left_join(sif, by = "feature")

# Points to estimate the potential 
grids100m <- grids100m %>%
  # Nesting
  nest(data_poly = everything()) %>% 
  # add centroids of the grids
  mutate(data_points = map(data_poly, st_centroid))

```

```{r est-pot-model, cache=TRUE, dependson="tbl-osm-data"}

# Aux. function for calculating the potential
f_pot <- function(df, fun, span, beta) {
  mcpotential(x = df,
              y = grids100m$data_points[[1]],
              var = "area_m2",
              fun = fun,
              span = span,
              beta = beta,
              limit = 5 * span)
  }

# Estimate potential (in percentage)
pot_est <- list()
for(i in seq_along(OMS$data_points)) {
  # Values
  potential <- f_pot(OMS$data_points[[i]],
                     OMS$fun[i], 
                     OMS$span[i],
                     OMS$beta[i])
  # Percentage relatively to the maximun
  pot_est[[i]] <- 100 * potential / max(potential)
  # Add names
  names(pot_est)[[i]] <- OMS$feature[i] 
}

# Add values to the grid cells of 100 x 100 m (grids100m)
pot <- rbind(pot_est) %>%
  as_tibble() %>% 
  unnest(everything())

grids100m <- grids100m %>% 
  bind_cols(pot %>% nest(pot = everything()))

```

```{r fig-pot-model, fig.width = 12, cache=TRUE, dependson="tbl-osm-data", fig.cap="Potential model"}
# Plots
grids100m %>% 
  select(data_poly, pot) %>% 
  unnest(c(data_poly, pot)) %>% 
  pivot_longer(-c(grid_ID, geometry),
               names_to = "feature",
               values_to = "value") %>% 
  st_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = value), col = NA) +
  scale_fill_viridis_c(name = "[%]", option = "magma", direction = -1) +
  geom_sf(data = cph_parish, fill = NA, color = "grey50", size = 0.05) +
  my_theme_map() +
  facet_wrap(~feature, ncol = 3)
  
```
